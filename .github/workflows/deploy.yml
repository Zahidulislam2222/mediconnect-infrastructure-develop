name: "üöÄ Global Multi-Cloud Deploy (Doctor Service)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend_v2/doctor-service/**'
      - 'backend_v2/shared/**'

env:
  AZURE_CONTAINER_REGISTRY: "zahidmediconnectacr"
  AZURE_RESOURCE_GROUP: "mediconnect-rg"
  GCP_PROJECT_ID: "mediconnect-analytics"
  GCP_REPO: "us-central1-docker.pkg.dev/mediconnect-analytics/mediconnect-repo"

jobs:
  # =========================================================
  # JOB 1: DEPLOY TO AZURE (US Region - HIPAA)
  # =========================================================
  deploy-azure-us:
    runs-on: "ubuntu-latest"
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîê Azure Login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "üîë Login to Azure Container Registry (ACR)"
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: "üßπ ZERO-ASSUMPTION FIX: Sanitize Build Context"
        run: |
          echo "Destroying restrictive .dockerignore files that block the Linux runner..."
          find . -name ".dockerignore" -delete
          
          echo "Creating one perfect Master .dockerignore..."
          echo "node_modules" > .dockerignore
          echo ".git" >> .dockerignore
          echo "backend_v2/node_modules" >> .dockerignore
          echo "backend_v2/doctor-service/node_modules" >> .dockerignore
          echo "backend_v2/patient-service/node_modules" >> .dockerignore

      - name: "üê≥ Build and Push Docker Image"
        run: |
          IMAGE_TAG=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/doctor-service:${{ github.sha }}
          docker build -t $IMAGE_TAG -f backend_v2/doctor-service/Dockerfile .
          docker push $IMAGE_TAG

      - name: "üöÄ Deploy to Azure Container Apps"
        uses: azure/container-apps-deploy-action@v1
        with:
          appSourcePath: "${{ github.workspace }}/backend_v2"
          acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
          containerAppName: "doctor-service"
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          imageToDeploy: "${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/doctor-service:${{ github.sha }}"
          environmentVariables: |
            NODE_ENV=production
            AWS_REGION=us-east-1

  # =========================================================
  # JOB 2: DEPLOY TO GCP (EU Region - GDPR)
  # =========================================================
  deploy-gcp-eu:
    runs-on: "ubuntu-latest"
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîê Authenticate to Google Cloud"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: "üõ†Ô∏è Set up Google Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2

      - name: "üîë Configure Docker for GCP Artifact Registry"
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: "üßπ ZERO-ASSUMPTION FIX: Sanitize Build Context"
        run: |
          echo "Destroying restrictive .dockerignore files that block the Linux runner..."
          find . -name ".dockerignore" -delete
          
          echo "Creating one perfect Master .dockerignore..."
          echo "node_modules" > .dockerignore
          echo ".git" >> .dockerignore
          echo "backend_v2/node_modules" >> .dockerignore
          echo "backend_v2/doctor-service/node_modules" >> .dockerignore
          echo "backend_v2/patient-service/node_modules" >> .dockerignore

      - name: "üê≥ Build and Push Docker Image to GCP"
        run: |
          IMAGE_TAG=${{ env.GCP_REPO }}/doctor-service-eu:${{ github.sha }}
          docker build -t $IMAGE_TAG -f backend_v2/doctor-service/Dockerfile .
          docker push $IMAGE_TAG

      - name: "üöÄ Deploy to Cloud Run (Europe-West3 / Frankfurt)"
        run: |
          IMAGE_TAG=${{ env.GCP_REPO }}/doctor-service-eu:${{ github.sha }}
          gcloud run deploy doctor-service-eu \
            --image $IMAGE_TAG \
            --project ${{ env.GCP_PROJECT_ID }} \
            --region europe-west3 \
            --port 8082 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars NODE_ENV=production