name: "üöÄ Global Multi-Cloud Deploy (Doctor Service)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend_v2/doctor-service/**'
      - 'backend_v2/shared/**'

env:
  AZURE_CONTAINER_REGISTRY: "zahidmediconnectacr"
  AZURE_RESOURCE_GROUP: "mediconnect-rg"
  GCP_PROJECT_ID: "mediconnect-analytics"
  GCP_REPO: "us-central1-docker.pkg.dev/mediconnect-analytics/mediconnect-repo"
  GCP_SERVICE_ACCOUNT: "data-logger@mediconnect-analytics.iam.gserviceaccount.com"

jobs:
  deploy-azure-us:
    runs-on: "ubuntu-latest"
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4
      
      - name: "üîê Azure Login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: "üîë Login to ACR"
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
      
      - name: "üßπ Sanitize Build Context"
        run: find . -name ".dockerignore" -delete
      
      - name: "üê≥ Build and Push to Azure"
        run: |
          IMAGE_TAG=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/doctor-service:${{ github.sha }}
          docker build -t $IMAGE_TAG -f backend_v2/doctor-service/Dockerfile .
          docker push $IMAGE_TAG

      - name: "üîê Push Secrets to Azure"
        # üü¢ AZURE FIX: Use CLI to create secrets because the Action doesn't support creating them on the fly
        run: |
          az containerapp secret set \
            --name doctor-service \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --secrets "aws-access-key-id=${{ secrets.AWS_ACCESS_KEY_ID }}" "aws-secret-access-key=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
      
      - name: "üöÄ Deploy Azure Container App"
        uses: azure/container-apps-deploy-action@v1
        with:
          acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
          containerAppName: "doctor-service"
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          imageToDeploy: "${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/doctor-service:${{ github.sha }}"
          # üü¢ Secrets are now referenced securely from the step above
          environmentVariables: "NODE_ENV=production AWS_REGION=us-east-1 AWS_ACCESS_KEY_ID=secretref:aws-access-key-id AWS_SECRET_ACCESS_KEY=secretref:aws-secret-access-key"

  deploy-gcp-eu:
    runs-on: "ubuntu-latest"
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4
        
      - name: "üîê GCP Login"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          
      - name: "üõ†Ô∏è Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        
      - name: "üîë Auth Docker"
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
        
      - name: "üßπ Sanitize Build Context"
        run: find . -name ".dockerignore" -delete
        
      - name: "üê≥ Build and Push to GCP"
        run: |
          IMAGE_TAG=${{ env.GCP_REPO }}/doctor-service-eu:${{ github.sha }}
          docker build -t $IMAGE_TAG -f backend_v2/doctor-service/Dockerfile .
          docker push $IMAGE_TAG

      - name: "üõ†Ô∏è Enable Secret Manager API"
        run: gcloud services enable secretmanager.googleapis.com
          
      - name: "üîí Inject GCP Secrets (HIPAA Compliance)"
        # üü¢ HIPAA 100% FIX: Pushes keys into GCP Secret Manager securely, then grants the container access.
        run: |
          echo -n "${{ secrets.AWS_ACCESS_KEY_ID }}" | gcloud secrets create aws_access_key_id --data-file=- || echo -n "${{ secrets.AWS_ACCESS_KEY_ID }}" | gcloud secrets versions add aws_access_key_id --data-file=-
          echo -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | gcloud secrets create aws_secret_access_key --data-file=- || echo -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | gcloud secrets versions add aws_secret_access_key --data-file=-
          gcloud secrets add-iam-policy-binding aws_access_key_id --member="serviceAccount:${{ env.GCP_SERVICE_ACCOUNT }}" --role="roles/secretmanager.secretAccessor"
          gcloud secrets add-iam-policy-binding aws_secret_access_key --member="serviceAccount:${{ env.GCP_SERVICE_ACCOUNT }}" --role="roles/secretmanager.secretAccessor"

      - name: "üöÄ Deploy GCP Cloud Run"
        run: |
          IMAGE_TAG=${{ env.GCP_REPO }}/doctor-service-eu:${{ github.sha }}
          # üü¢ Uses --update-secrets to mount them securely from the Vault instead of plaintext!
          gcloud run deploy doctor-service-eu \
            --image "$IMAGE_TAG" \
            --project ${{ env.GCP_PROJECT_ID }} \
            --region europe-west3 \
            --port 8082 \
            --platform managed \
            --service-account ${{ env.GCP_SERVICE_ACCOUNT }} \
            --set-env-vars "NODE_ENV=production,AWS_REGION=eu-central-1" \
            --update-secrets "AWS_ACCESS_KEY_ID=aws_access_key_id:latest,AWS_SECRET_ACCESS_KEY=aws_secret_access_key:latest"